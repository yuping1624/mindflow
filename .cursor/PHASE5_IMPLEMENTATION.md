# Phase 5: RAG Implementation - å¯¦ç¾ç¸½çµ

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. Embedding ç¶­åº¦ä¿®å¾©ï¼ˆé—œéµä¿®å¾©ï¼‰
- âœ… **ç§»é™¤å¡«å……ç­–ç•¥**ï¼šä¸å†å°‡ 384D å¡«å……åˆ° 1536D
- âœ… **ç›´æ¥ä½¿ç”¨åŸå§‹ embedding**ï¼šHuggingFace çš„ 384D å‘é‡ç›´æ¥å­˜å„²å’Œä½¿ç”¨
- âœ… **ç¶­åº¦é©—è­‰**ï¼šæ·»åŠ äº†é©—è­‰é‚è¼¯ï¼Œç¢ºä¿åªæ¥å— 384D æˆ– 1536D

**é‡è¦**ï¼šéœ€è¦é‹è¡Œ migration å°‡è³‡æ–™åº« schema å¾ `vector(1536)` æ›´æ–°ç‚º `vector(384)`
- Migration æ–‡ä»¶ï¼š`db/migrate_to_384d.sql`

### 2. RAG æª¢ç´¢å„ªåŒ–
- âœ… **ä½¿ç”¨å®‰å…¨ç‰ˆæœ¬çš„ match_entries**ï¼šç§»é™¤äº† `match_user_id` åƒæ•¸ï¼Œä½¿ç”¨ `auth.uid()` å…§éƒ¨é©—è­‰
- âœ… **RAG åƒæ•¸é…ç½®**ï¼š
  - `MIN_SIMILARITY_THRESHOLD = 0.65`ï¼ˆæ¯”ä¹‹å‰çš„ 0.7 æ›´å¯¬é¬†ï¼Œé©åˆ HuggingFace æ¨¡å‹ï¼‰
  - `RAG_MATCH_COUNT = 5`ï¼ˆå¾è³‡æ–™åº«æª¢ç´¢ 5 æ¢ï¼‰
  - `RAG_PROMPT_COUNT = 3`ï¼ˆåªæ³¨å…¥å‰ 3 æ¢åˆ° LLM prompt ä»¥ç¯€çœ tokensï¼‰
- âœ… **å„ªé›…é™ç´š**ï¼šRAG å¤±æ•—æ™‚è¨˜éŒ„éŒ¯èª¤ä½†ç¹¼çºŒè™•ç†ï¼Œä¸å½±éŸ¿åŸºæœ¬åŠŸèƒ½

### 3. AI Prompt å„ªåŒ–
- âœ… **çµæ§‹åŒ–æ ¼å¼**ï¼šä½¿ç”¨ `[Date: YYYY-MM-DD] [Tone: Neutral] Content: "..."` æ ¼å¼
- âœ… **åŒ…å«å®Œæ•´ metadata**ï¼šæ—¥æœŸã€toneã€å®Œæ•´ transcriptionï¼ˆä¸å†æˆªå–å‰ 100 å­—ç¬¦ï¼‰
- âœ… **Mode-specific RAG ä½¿ç”¨**ï¼š
  - **Coaching mode**ï¼šç©æ¥µä½¿ç”¨ RAG ä¸Šä¸‹æ–‡ï¼Œè­˜åˆ¥æ¨¡å¼ä¸¦æä¾›æ·±åº¦è¦‹è§£
  - **Smart mode**ï¼šé©åº¦ä½¿ç”¨ RAGï¼Œåœ¨æœ‰æ„ç¾©æ™‚å¼•ç”¨æ¨¡å¼
  - **Listening mode**ï¼šæœ€å°åŒ–ä½¿ç”¨ RAGï¼Œåƒ…åœ¨é©—è­‰æƒ…æ„Ÿæ™‚å¼•ç”¨

### 4. UI é¡¯ç¤ºå„ªåŒ–
- âœ… **ç›¸ä¼¼åº¦æ¨™ç±¤é¡¯ç¤º**ï¼ˆOption Bï¼‰ï¼š
  - "Deep Connection" (>0.8) - æ·±è‰²ä¸»é¡Œè‰²
  - "Related" (0.7-0.8) - è—è‰²
  - "Somewhat Related" (<0.7) - ç°è‰²
- âœ… **Entry Detail é é¢**ï¼šé¡¯ç¤ºç›¸é—œæ¢ç›®ï¼Œå¸¶ç›¸ä¼¼åº¦æ¨™ç±¤å’Œ tone badge
- âœ… **é»æ“Šè·³è½‰**ï¼šé»æ“Šç›¸é—œæ¢ç›®å¯è·³è½‰åˆ°è©²æ¢ç›®çš„è©³ç´°é é¢

### 5. API æ›´æ–°
- âœ… **`/api/journal`**ï¼š
  - ç§»é™¤ embedding å¡«å……é‚è¼¯
  - æ›´æ–° match_entries èª¿ç”¨ï¼ˆç§»é™¤ match_user_idï¼‰
  - æ›´æ–° buildSystemPrompt ä½¿ç”¨çµæ§‹åŒ–æ ¼å¼
- âœ… **`/api/entries/[id]`**ï¼š
  - è¿”å›ç›¸é—œæ¢ç›®æ™‚åŒ…å« similarity åˆ†æ•¸
  - é€šéæŸ¥è©¢ç•¶å‰ entry çš„ embedding ä¸¦èª¿ç”¨ match_entries ç²å–ç›¸ä¼¼åº¦

## ğŸ“‹ éœ€è¦åŸ·è¡Œçš„ Migration

**é‡è¦**ï¼šåœ¨éƒ¨ç½²å‰å¿…é ˆåŸ·è¡Œä»¥ä¸‹ migrationï¼š

```sql
-- æ–‡ä»¶ä½ç½®ï¼šdb/migrate_to_384d.sql
-- é€™æœƒï¼š
-- 1. å°‡ embedding æ¬„ä½å¾ vector(1536) æ”¹ç‚º vector(384)
-- 2. é‡æ–°å‰µå»º HNSW ç´¢å¼•
-- 3. æ›´æ–° match_entries å‡½æ•¸ç°½åç‚º vector(384)
```

**æ³¨æ„**ï¼š
- å¦‚æœè³‡æ–™åº«ä¸­å·²æœ‰ 1536D çš„ embeddingsï¼Œéœ€è¦é‡æ–°ç”Ÿæˆï¼ˆåˆªé™¤èˆŠçš„ï¼Œå‰µå»ºæ–°çš„ï¼‰
- å°æ–¼æ–°å®‰è£ï¼Œç›´æ¥é‹è¡Œ migration å³å¯

## ğŸ”§ æŠ€è¡“æ±ºç­–èªªæ˜

### ç‚ºä»€éº¼ä¸ä½¿ç”¨å¡«å……ç­–ç•¥ï¼Ÿ
- **æº–ç¢ºæ€§å•é¡Œ**ï¼šå¡«å……æœƒç ´å£ cosine similarity è¨ˆç®—çš„æº–ç¢ºæ€§
- **æ•¸å­¸æ­£ç¢ºæ€§**ï¼š384D å‘é‡ç©ºé–“å’Œ 1536D å‘é‡ç©ºé–“æ˜¯ä¸åŒçš„ï¼Œä¸èƒ½ç°¡å–®å¡«å……
- **æ€§èƒ½**ï¼šç›´æ¥ä½¿ç”¨ 384D æ›´é«˜æ•ˆï¼Œç´¢å¼•æ›´å°

### ç‚ºä»€éº¼ threshold è¨­ç‚º 0.65ï¼Ÿ
- HuggingFace çš„ `all-MiniLM-L6-v2` æ¨¡å‹åœ¨ç›¸ä¼¼åº¦è¨ˆç®—ä¸Šå¯èƒ½ä¸å¦‚ OpenAI çš„æ¨¡å‹ç²¾ç¢º
- 0.65 æ˜¯ä¸€å€‹å¹³è¡¡é»ï¼Œæ—¢èƒ½æ‰¾åˆ°ç›¸é—œæ¢ç›®ï¼Œåˆä¸æœƒåŒ…å«å¤ªå¤šä¸ç›¸é—œçš„å…§å®¹
- å¯ä»¥æ ¹æ“šå¯¦éš›ä½¿ç”¨æƒ…æ³èª¿æ•´

### ç‚ºä»€éº¼åªæ³¨å…¥å‰ 3 æ¢åˆ° promptï¼Ÿ
- **Token é™åˆ¶**ï¼šLLM æœ‰ token é™åˆ¶ï¼Œéå¤šä¸Šä¸‹æ–‡æœƒå¢åŠ æˆæœ¬ä¸¦å¯èƒ½é™ä½è³ªé‡
- **ç›¸é—œæ€§**ï¼šå‰ 3 æ¢é€šå¸¸æ˜¯æœ€ç›¸é—œçš„ï¼Œè¶³å¤ æä¾›ä¸Šä¸‹æ–‡
- **æ€§èƒ½**ï¼šæ¸›å°‘ prompt é•·åº¦å¯ä»¥åŠ å¿«éŸ¿æ‡‰é€Ÿåº¦

## ğŸ¯ ç¬¦åˆçš„æ±ºç­–

æ ¹æ“š `.cursor/PHASE5_PLANNING.md` ä¸­çš„æ±ºç­–ï¼š

1. âœ… **1.1 Integration**: Option C - æ ¹æ“š AI mode æ±ºå®šå¦‚ä½•ä½¿ç”¨ RAG
2. âœ… **1.2 Format**: Option C - çµæ§‹åŒ–æ ¼å¼ `[Date: YYYY-MM-DD] [Tone: Neutral] Content: "..."`
3. âœ… **1.3 Quantity**: æª¢ç´¢ 5 æ¢ï¼Œæ³¨å…¥å‰ 3 æ¢
4. âœ… **2.1 Threshold**: 0.65ï¼ˆå¯é…ç½®å¸¸æ•¸ï¼‰
5. âœ… **2.2 Count**: 5 æ¢
6. âœ… **2.3 Time Range**: Option A - ä¸é™åˆ¶æ™‚é–“ç¯„åœ
7. âœ… **3.1 Location**: Option A - åªåœ¨ entry detail é é¢é¡¯ç¤º
8. âœ… **3.2 Score Display**: Option B - ä½¿ç”¨æ¨™ç±¤ï¼ˆDeep Connection/Relatedï¼‰
9. âœ… **3.3 Interaction**: Option A - é»æ“Šè·³è½‰åˆ°ç›¸é—œæ¢ç›®
10. âœ… **5.1 Function**: Option B - ä½¿ç”¨å®‰å…¨ç‰ˆæœ¬ï¼ˆauth.uid()ï¼‰
11. âœ… **5.3 Error Handling**: Option B - å„ªé›…é™ç´š

## ğŸ“ å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **Embedding ç¶­åº¦é·ç§»**ï¼š
   - è€ƒæ…®ç‚ºä¸åŒ provider ä½¿ç”¨ä¸åŒçš„ schema
   - æˆ–è€…ä½¿ç”¨ `vector`ï¼ˆç„¡å›ºå®šé•·åº¦ï¼‰ä½†é€™æœƒå½±éŸ¿æ€§èƒ½

2. **ç›¸ä¼¼åº¦è¨ˆç®—å„ªåŒ–**ï¼š
   - å¯ä»¥è€ƒæ…®ç·©å­˜ç†±é–€æŸ¥è©¢çµæœ
   - æ‰¹é‡è™•ç†å¤šå€‹æ¢ç›®çš„ç›¸ä¼¼åº¦è¨ˆç®—

3. **UI å¢å¼·**ï¼š
   - å¯ä»¥æ·»åŠ ç›¸ä¼¼åº¦åˆ†æ•¸çš„ tooltipï¼ˆé¡¯ç¤ºåŸå§‹åˆ†æ•¸ï¼‰
   - å¯ä»¥æ·»åŠ éæ¿¾é¸é …ï¼ˆåªé¡¯ç¤º "Deep Connection" çš„æ¢ç›®ï¼‰

4. **Prompt é€²ä¸€æ­¥å„ªåŒ–**ï¼š
   - å¯ä»¥æ ¹æ“šæ¢ç›®çš„æƒ…æ„Ÿæ¨™ç±¤é¸æ“‡æ€§åœ°åŒ…å«æŸäº›æ¢ç›®
   - å¯ä»¥ç¸½çµå¤šå€‹æ¢ç›®çš„å…±åŒä¸»é¡Œ

## ğŸš€ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

- [ ] é‹è¡Œ `db/migrate_to_384d.sql` migration
- [ ] é©—è­‰ `match_entries` å‡½æ•¸å·²æ›´æ–°ç‚º `vector(384)` ç‰ˆæœ¬
- [ ] å¦‚æœå·²æœ‰æ•¸æ“šï¼Œé‡æ–°ç”Ÿæˆæ‰€æœ‰ embeddingsï¼ˆåˆªé™¤èˆŠçš„ï¼Œå‰µå»ºæ–°çš„ï¼‰
- [ ] æ¸¬è©¦ RAG æª¢ç´¢åŠŸèƒ½
- [ ] é©—è­‰ç›¸ä¼¼åº¦æ¨™ç±¤æ­£ç¢ºé¡¯ç¤º
- [ ] æª¢æŸ¥ä¸åŒ AI mode ä¸‹çš„ prompt æ ¼å¼

